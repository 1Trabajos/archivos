function abrirModalAdiciones(){const e=document.getElementById("adicion-modal");e&&(e.style.display="block")}function cerrarModalAdiciones(){const e=document.getElementById("adicion-modal");e&&(e.style.display="none")}function agregarAdicion(e,o,t){const n=localStorage.getItem("carritoCheckout")||localStorage.getItem("carrito"),a=n?JSON.parse(n):[],i={nombre:e,precio:o,imagen:t,cantidad:1};a.push(i),localStorage.setItem("carritoCheckout",JSON.stringify(a)),mostrarProductosCheckout(a),calcularTotalesCheckout(a),cerrarModalAdiciones(),mostrarNotificacion(`Adición "${e}" agregada al carrito ($${o})`)}function mostrarProductosCheckout(e){const o=document.getElementById("checkout-items");let t="<h3>Resumen del pedido</h3>";e.forEach(((e,o)=>{const n=e.nombre.startsWith("Adición")?`<button class="eliminar-adicion-btn" data-adicion-id="${o}">Eliminar</button>`:"";t+=`\n            <div class="checkout-item">\n                <div class="checkout-item-img">\n                    <img src="${e.imagen}" alt="${e.nombre}">\n                </div>\n                <div class="checkout-item-details">\n                    <div class="checkout-item-name">${e.nombre}</div>\n                    <div class="checkout-item-price">$${e.precio} x ${e.cantidad}</div>\n                </div>\n                <div class="checkout-item-total">$${e.precio*e.cantidad}</div>\n                ${n}\n            </div>\n        `})),o.innerHTML=t;document.querySelectorAll(".eliminar-adicion-btn").forEach((e=>{e.addEventListener("click",(function(){eliminarAdicion(parseInt(e.getAttribute("data-adicion-id")))}))}))}function eliminarAdicion(e){const o=JSON.parse(localStorage.getItem("carritoCheckout")||localStorage.getItem("carrito")||"[]");if(e>=0&&e<o.length){const t=o[e].nombre;o.splice(e,1),localStorage.setItem("carritoCheckout",JSON.stringify(o)),mostrarProductosCheckout(o),calcularTotalesCheckout(o),mostrarNotificacion(`Adición "${t}" eliminada del carrito`)}}function eliminarTodasAdiciones(){const e=JSON.parse(localStorage.getItem("carritoCheckout")||localStorage.getItem("carrito")||"[]").filter((e=>!e.nombre.startsWith("Adición")));localStorage.setItem("carritoCheckout",JSON.stringify(e)),mostrarProductosCheckout(e),calcularTotalesCheckout(e),mostrarNotificacion("Todas las adiciones han sido eliminadas")}function calcularTotalesCheckout(e){const o=e.reduce(((e,o)=>e+o.precio*o.cantidad),0),t=o>0?12e3:0;let n=0;const a=document.getElementById("globos-helio");if(a){const e=parseInt(a.value)||0;e>0&&(n+=4500*e)}const i=document.getElementById("mensaje-predefinido");i&&i.value;const c=o+t+n;document.getElementById("checkout-subtotal").textContent=`$${o}`,document.getElementById("checkout-envio").textContent=`$${t}`;const r=document.getElementById("checkout-total"),d=document.getElementById("adicionales-row");if(n>0)if(d)d.querySelector("span:last-child").textContent=`$${n}`;else{const e=document.createElement("div");e.id="adicionales-row",e.className="checkout-total-row",e.innerHTML=`\n                <span>Adicionales:</span>\n                <span>$${n}</span>\n            `;const o=document.querySelector(".checkout-total-final");r.insertBefore(e,o)}else d&&d.remove();document.getElementById("checkout-total-valor").textContent=`$${c}`}function procesarPedido(e){e.preventDefault();const o=document.getElementById("nombre").value,t=document.getElementById("email").value,n=document.getElementById("direccion").value;if(!o||!t||!n)return void mostrarNotificacion("Por favor completa todos los campos obligatorios");const a=JSON.parse(localStorage.getItem("carritoCheckout")||localStorage.getItem("carrito")),i=generarCodigoPedido();if(console.log("Comprobando Firebase..."),!firebase.apps.length){console.log("Inicializando Firebase...");const e={apiKey:"AIzaSyC5QFujt2nmR40p6lXh3Yft7e7gxsvu7oY",authDomain:"morenitta-57ed3.firebaseapp.com",databaseURL:"https://morenitta-57ed3-default-rtdb.firebaseio.com",projectId:"morenitta-57ed3",storageBucket:"morenitta-57ed3.appspot.com",messagingSenderId:"813042769292",appId:"1:813042769292:web:e9bf4d9ba0eb80919ccaa9"};firebase.initializeApp(e)}const c=firebase.database();console.log("Firebase Database inicializada"),generarResumenDescargable(i).then((e=>{console.log("Resumen generado correctamente");const r=(new Date).toISOString(),d=a.reduce(((e,o)=>e+o.precio*o.cantidad),0),l=d>0?12e3:0;let s=0;const m=document.getElementById("globos-helio"),u=m&&parseInt(m.value)||0;u>0&&(s+=4500*u);const g=document.getElementById("mensaje-predefinido");g&&"personalizado"===g.value&&(s+=0);const p=d+l+s,f=document.getElementById("motivo");let v="No especificado";if(f)switch(f.value){case"cumpleanos":v="Feliz cumpleaños";break;case"aniversario":v="Feliz aniversario";break;case"feliz":v="Feliz mes";break;case"grado":v="Feliz grado";break;case"dia":v="feliz dia";break;case"tequiero":v="Te quiero";break;case"amo":v="Te amo"}let y="Ninguno";const h=document.getElementById("mensaje-personalizado");g&&"personalizado"===g.value&&h?y=`Personalizado: "${h.value}" (+0)`:g&&g.value&&"personalizado"!==g.value&&(y=g.options[g.selectedIndex].text);const b=document.querySelector(".globos-imagenes-1 img.seleccionado"),E=b?b.getAttribute("data-url"):"",I={id:i,fecha:r,fechaFormateada:new Date(r).toLocaleDateString(),cliente:{nombre:o,email:t,direccion:n,telefono:document.getElementById("telefono").value},adicionales:{motivo:v,globos:u>0?`${u} con helio (+$${4500*u})`:"Ninguno",colorGlobo:E,mensaje:y},productos:a,metodo_pago:"efectivo"===document.getElementById("metodo-pago").value?"Efectivo al recibir":"Transferencia bancaria",subtotal:d,envio:l,adicionales_costo:s,total:p,estado:"Pendiente",timestamp:(new Date).getTime()};console.log("Datos del pedido preparados:",I),c.ref("pedidos").push(I).then((e=>{console.log("Pedido guardado con ID: ",e.key),document.getElementById("checkout-form").innerHTML=`\n                    <div class="procesando-pedido">\n                        <h3>¡Pedido procesado correctamente!</h3>\n                        <p>Su código de pedido es: ${i}</p>\n                         <p>la facutra se a descargado en formato png </p>\n                        <p>Para confirmar su pedido</p>\n                        <p> Será redirigido al whatsapp en 5 segundos.</p>\n                        <p>Favor anotar su código de pedido para la confirmación.</p>\n                       \n                    </div>\n                `,localStorage.removeItem("carrito"),localStorage.removeItem("carritoCheckout"),localStorage.setItem("checkoutCompleto","true"),setTimeout((()=>{const e=`https://wa.me/573023144445?text=${encodeURIComponent(`Hola, mi código de pedido es *${i}* y mi nombre es *${o}*.`)}`;window.location.href=e}),3e3)})).catch((e=>{console.error("Error al guardar el pedido: ",e),mostrarNotificacion("Hubo un error al procesar su pedido: "+e.message)}))})).catch((e=>{console.error("Error al generar resumen:",e),mostrarNotificacion("Error al generar el resumen del pedido")}))}function generarCodigoPedido(){return Math.floor(1e5+9e5*Math.random()).toString()}function generarResumenDescargable(e){return new Promise(((o,t)=>{const n=document.getElementById("nombre").value||"No especificado",a=document.getElementById("email").value||"No especificado",i=document.getElementById("telefono").value||"No especificado",c=document.getElementById("direccion").value||"No especificado",r=document.getElementById("metodo-pago").value,d=document.getElementById("motivo"),l=document.getElementById("globos-helio").value,s=document.getElementById("mensaje-predefinido"),m=document.getElementById("mensaje-personalizado").value,u=document.querySelector(".globos-imagenes-1 img.seleccionado"),g=u?u.getAttribute("data-url"):"",p=localStorage.getItem("carritoCheckout")||localStorage.getItem("carrito"),f=JSON.parse(p),v=f.reduce(((e,o)=>e+o.precio*o.cantidad),0),y=v>0?12e3:0;let h=0;const b=parseInt(l)||0;b>0&&(h+=4500*b),s&&"personalizado"===s.value&&(h+=0);const E=v+y+h;let I="Ninguno";s&&"personalizado"===s.value&&m?I=`Personalizado: "${m}" (0)`:s&&s.value&&"personalizado"!==s.value&&(I=s.options[s.selectedIndex].text);let k=b>0?`${b} con helio (+$${4500*b})`:"Ninguno";g&&(k+=` (Color seleccionado: <img src="${g}" alt="Globo" style="width: 20px; height: 20px; vertical-align: middle;">)`);let $="No especificado";if(d)switch(d.value){case"cumpleanos":$="Feliz cumpleaños";break;case"aniversario":$="Feliz aniversario";break;case"feliz":$="Feliz mes";break;case"grado":$="Feliz grado";break;case"dia":$="Feliz día";break;case"tequiero":$="Te quiero";break;case"amo":$="Te amo";break;default:$="No especificado"}const S=document.getElementById("resumen-items-print"),B=document.getElementById("resumen-totales-print"),C=document.getElementById("resumen-cliente-print"),x=document.getElementById("resumen-adicionales-print");let L="";f.forEach((e=>{L+=`\n                <div style="display: flex; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px;">\n                    <div style="width: 50px; height: 50px; border-radius: 5px; overflow: hidden; margin-right: 15px;">\n                        <img src="${e.imagen}" alt="${e.nombre}" style="width: 100%; height: 100%; object-fit: cover;">\n                    </div>\n                    <div style="flex: 1;">\n                        <div style="font-weight: bold;">${e.nombre}</div>\n                        <div style="color: #666; font-size: 14px;">$${e.precio} x ${e.cantidad}</div>\n                    </div>\n                    <div style="font-weight: bold; color: #c5a8a3;">$${e.precio*e.cantidad}</div>\n                </div>\n            `})),S.innerHTML=L,B.innerHTML=`\n            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">\n                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">\n                    <span>Subtotal:</span>\n                    <span>$${v}</span>\n                </div>\n                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">\n                    <span>Envío:</span>\n                    <span>$${y}</span>\n                </div>\n                ${h>0?`\n                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">\n                    <span>Adicionales:</span>\n                    <span>$${h}</span>\n                </div>\n                `:""}\n                <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 18px; font-weight: bold; color: #c5a8a3;">\n                    <span>Total:</span>\n                    <span>$${E}</span>\n                </div>\n            </div>\n        `,C.innerHTML=`\n            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">\n                <h3 style="margin-bottom: 10px;">Datos de envío</h3>\n                <p><strong>Código:</strong> ${e}</p>\n                <p><strong>Nombre:</strong> ${n}</p>\n                <p><strong>Email:</strong> ${a}</p>\n                <p><strong>Teléfono:</strong> ${i}</p>\n                <p><strong>Dirección:</strong> ${c}</p>\n                <p><strong>Método de pago:</strong> ${"efectivo"===r?"Efectivo al recibir":"Transferencia bancaria"}</p>\n            </div>\n        `,x.innerHTML=`\n            <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">\n                <h3 style="margin-bottom: 10px;">Opciones adicionales</h3>\n                <p><strong>Mensaje de globo:</strong> ${$}</p>\n                <p><strong>Globos:</strong> ${k}</p>\n                <p><strong>Mensaje:</strong> ${I}</p>\n            </div>\n            <div style="margin-top: 20px; text-align: center; font-size: 12px; color: #999;">\n                <p>Fecha del pedido: ${(new Date).toLocaleDateString()}</p>\n            </div>\n        `;const N=document.getElementById("resumen-para-imprimir");N.style.display="block",html2canvas(N,{backgroundColor:"#ffffff",scale:2,logging:!1,useCORS:!0}).then((e=>{N.style.display="none";const t=e.toDataURL("image/png"),n=document.createElement("a");n.href=t,n.download="resumen-pedido.png",document.body.appendChild(n),n.click(),document.body.removeChild(n),mostrarNotificacion("El resumen se ha descargado correctamente"),o(t)})).catch((e=>{console.error("Error al generar la imagen:",e),mostrarNotificacion("Hubo un error al generar la imagen del resumen"),t(e)}))}))}function mostrarNotificacion(e){const o=document.getElementById("toastNotification");if(o)o.textContent=e,o.style.display="block",setTimeout((()=>{o.style.display="none"}),3e3);else{const o=document.createElement("div");o.className="toast-notification",o.textContent=e,document.body.appendChild(o),setTimeout((()=>{document.body.removeChild(o)}),3e3)}}document.addEventListener("DOMContentLoaded",(function(){const e=localStorage.getItem("carritoCheckout")||localStorage.getItem("carrito");if(e&&"[]"!==e){const o=JSON.parse(e);mostrarProductosCheckout(o),calcularTotalesCheckout(o)}else document.getElementById("checkout-items").innerHTML='\n                <div class="carrito-vacio">\n                    <i>🛒</i>\n                    <p>El carrito está vacío</p>\n                    <p><a href="index.html">Volver a la tienda</a></p>\n                </div>\n            ',document.getElementById("checkout-total").style.display="none",document.getElementById("checkout-form").style.display="none";const o=document.getElementById("checkout-form");o&&o.addEventListener("submit",procesarPedido);const t=document.getElementById("globos");t&&t.addEventListener("change",(function(){calcularTotalesCheckout(JSON.parse(e))}));const n=document.getElementById("agregar-adicion");n&&n.addEventListener("click",(function(){abrirModalAdiciones()}));const a=document.getElementById("close-modal");a&&a.addEventListener("click",cerrarModalAdiciones);const i=document.getElementById("adicion-modal");i&&i.addEventListener("click",(function(e){e.target===i&&cerrarModalAdiciones()}))})),document.addEventListener("DOMContentLoaded",(function(){mostrarProductosCheckout(JSON.parse(localStorage.getItem("carritoCheckout")||localStorage.getItem("carrito")||[]));const e=document.getElementById("eliminar-adiciones");e&&e.addEventListener("click",(function(){eliminarTodasAdiciones()}))})),document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("globos-helio"),o=document.getElementById("ver-colores-globos"),t=document.getElementById("modal-globos-1"),n=t.querySelector(".close-1"),a=t.querySelectorAll(".globos-imagenes-1 img"),i=document.getElementById("seleccionar-globo");let c="";e&&o&&e.addEventListener("change",(function(){this.value>0?o.style.display="block":o.style.display="none"})),o&&t&&o.addEventListener("click",(function(){t.style.display="block"})),n&&n.addEventListener("click",(function(){t.style.display="none"})),window.addEventListener("click",(function(e){e.target===t&&(t.style.display="none")})),a&&a.forEach((e=>{e.addEventListener("click",(function(){a.forEach((e=>e.classList.remove("seleccionado"))),this.classList.add("seleccionado"),c=this.getAttribute("data-url")}))})),i&&i.addEventListener("click",(function(){c?(console.log("Globo seleccionado:",c),t.style.display="none"):alert("Por favor, selecciona un color de globo.")}))})),document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("mensaje-predefinido"),o=document.getElementById("mensaje-personalizado-container");e&&o&&e.addEventListener("change",(function(){"personalizado"===this.value?o.style.display="block":o.style.display="none";calcularTotalesCheckout(JSON.parse(localStorage.getItem("carritoCheckout")||localStorage.getItem("carrito")))}));const t=document.getElementById("globos-helio");t&&t.addEventListener("change",(function(){calcularTotalesCheckout(JSON.parse(localStorage.getItem("carritoCheckout")||localStorage.getItem("carrito")))}))}));