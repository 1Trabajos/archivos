const firebaseConfig={apiKey:"AIzaSyC5QFujt2nmR40p6lXh3Yft7e7gxsvu7oY",authDomain:"morenitta-57ed3.firebaseapp.com",databaseURL:"https://morenitta-57ed3-default-rtdb.firebaseio.com",projectId:"morenitta-57ed3",storageBucket:"morenitta-57ed3.appspot.com",messagingSenderId:"813042769292",appId:"1:813042769292:web:e9bf4d9ba0eb80919ccaa9"};firebase.apps.length||firebase.initializeApp(firebaseConfig);const db=firebase.database(),pedidosRef=db.ref("pedidos"),productosRef=db.ref("productos"),pedidosBody=document.getElementById("pedidos-body"),loadingElement=document.getElementById("loading"),pedidoDetalle=document.getElementById("pedido-detalle"),modal=document.getElementById("imagen-modal"),modalImage=document.getElementById("modal-image"),modalTitle=document.getElementById("modal-title"),closeModal=document.getElementById("close-modal"),filtroEstado=document.getElementById("filtro-estado"),filtroCodigo=document.getElementById("filtro-codigo"),filtroFecha=document.getElementById("filtro-fecha"),filtroCliente=document.getElementById("filtro-cliente"),btnBuscarEstado=document.getElementById("btn-buscar-estado"),btnBuscarCodigo=document.getElementById("btn-buscar-codigo"),btnBuscarFecha=document.getElementById("btn-buscar-fecha"),btnBuscarCliente=document.getElementById("btn-buscar-cliente");function aplicarFiltros(){cargarPedidos(filtroEstado.value,filtroCodigo.value,filtroFecha.value,filtroCliente.value)}function limpiarFiltros(){filtroEstado.value="",filtroCodigo.value="",filtroFecha.value="",filtroCliente.value=""}function cargarPedidos(e="",t="",o="",n=""){pedidosBody.innerHTML="",loadingElement.style.display="block",pedidoDetalle.style.display="none",pedidosRef.off(),pedidosRef.orderByChild("fechaFormateada").on("value",(i=>{if(loadingElement.style.display="none",pedidosBody.innerHTML="",!i.exists())return void(pedidosBody.innerHTML='<tr><td colspan="6" style="text-align: center;">No hay pedidos para mostrar</td></tr>');const a=[];if(i.forEach((i=>{const d=i.val();d.key=i.key;const r=!e||d.estado===e,s=!t||d.id&&d.id.includes(t),c=!n||d.cliente.nombre&&d.cliente.nombre.toLowerCase().includes(n.toLowerCase());let l=!0;if(o){const e=o.split("/");if(3===e.length){const t=parseInt(e[0],10),o=parseInt(e[1],10),n=parseInt(e[2],10);let i;try{if(d.fechaFormateada)if("string"==typeof d.fechaFormateada){const e=d.fechaFormateada.split("/");if(3===e.length){const i=parseInt(e[0],10),a=parseInt(e[1],10),d=parseInt(e[2],10);l=i===t&&a===o&&d===n}}else i=new Date(d.fechaFormateada);else d.fecha?i=new Date(d.fecha):l=!1;if(i&&i instanceof Date&&!isNaN(i.getTime())){const e=i.getDate(),a=i.getMonth()+1,d=i.getFullYear();l=e===t&&a===o&&d===n}}catch(e){console.error("Error al procesar fecha:",e),l=!1}}else l=!1}r&&s&&l&&c&&a.push(d)})),a.sort(((e,t)=>t.timestamp-e.timestamp)),0===a.length)return void(pedidosBody.innerHTML='<tr><td colspan="6" style="text-align: center;">No hay pedidos para mostrar</td></tr>');a.forEach((e=>{const t=document.createElement("tr");let o="";switch(e.estado){case"Pendiente":default:o="badge-pendiente";break;case"Enviado":o="badge-enviado";break;case"Entregado":o="badge-entregado";break;case"Cancelado":o="badge-cancelado"}const n=e.fechaFormateada||new Date(e.fecha).toLocaleDateString(),i=e.id||"Sin código";t.innerHTML=`\n        <td>${i}</td>\n        <td>${n}</td>\n        <td>${e.cliente.nombre}</td>\n        <td>$${e.total}</td>\n        <td><span class="badge ${o}">${e.estado}</span></td>\n        <td>\n            <button class="btn btn-ver" data-key="${e.key}">Ver detalle</button>\n        </td>\n    `,pedidosBody.appendChild(t)}));document.querySelectorAll(".btn-ver").forEach((e=>{e.addEventListener("click",(e=>{mostrarDetallePedido(e.target.getAttribute("data-key"))}))}))}),(e=>{console.error("Error al obtener pedidos: ",e),loadingElement.style.display="none",pedidosBody.innerHTML='<tr><td colspan="6" style="text-align: center;">Error al cargar los pedidos</td></tr>'}))}function mostrarDetallePedido(e){pedidoDetalle.innerHTML="Cargando...",pedidoDetalle.style.display="block",pedidosRef.child(e).once("value").then((t=>{if(t.exists()){const o=t.val();let n="";o.productos.forEach((e=>{n+=`\n                        <div style="display: flex; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px;">\n                            <div style="margin-right: 10px;">\n                                <span class="producto-nombre" data-id="${e.id}">${e.nombre}</span>\n                            </div>\n                            <div style="margin-left: auto;">$${e.precio} x ${e.cantidad} = $${e.precio*e.cantidad}</div>\n                        </div>\n                    `}));const i=o.fechaFormateada||new Date(o.fecha).toLocaleDateString(),a=o.codigoFactura||o.id||"Sin código";pedidoDetalle.innerHTML=`\n                    <h2>Detalles del Pedido #${a}</h2>\n                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">\n                        <div style="flex: 1; min-width: 300px;">\n                            <h3>Información del Cliente</h3>\n                            <p><strong>Nombre:</strong> ${o.cliente.nombre}</p>\n                            <p><strong>Email:</strong> ${o.cliente.email}</p>\n                            <p><strong>Teléfono:</strong> ${o.cliente.telefono||"No especificado"}</p>\n                            <p><strong>Dirección:</strong> ${o.cliente.direccion}</p>\n                            \n                            <h3>Detalles del Pedido</h3>\n                            <p><strong>Código:</strong> ${a}</p>\n                            <p><strong>Fecha:</strong> ${i}</p>\n                            <p><strong>Estado:</strong> \n                                <select id="cambiar-estado" data-key="${e}">\n                                    <option value="Pendiente" ${"Pendiente"===o.estado?"selected":""}>Pendiente</option>\n                                    <option value="Enviado" ${"Enviado"===o.estado?"selected":""}>Enviado</option>\n                                    <option value="Entregado" ${"Entregado"===o.estado?"selected":""}>Entregado</option>\n                                    <option value="Cancelado" ${"Cancelado"===o.estado?"selected":""}>Cancelado</option>\n                                </select>\n                            </p>\n                            <p><strong>Método de pago:</strong> ${o.metodo_pago}</p>\n                        </div>\n                        \n                        <div style="flex: 1; min-width: 300px;">\n                            <h3>Productos</h3>\n                            ${n}\n                            \n                            <div style="margin-top: 20px;">\n                                <p><strong>Subtotal:</strong> $${o.subtotal}</p>\n                                <p><strong>Envío:</strong> $${o.envio}</p>\n                                ${o.adicionales_costo>0?`<p><strong>Adicionales:</strong> $${o.adicionales_costo}</p>`:""}\n                                <p style="font-size: 18px;"><strong>Total:</strong> $${o.total}</p>\n                            </div>\n                            \n                            <h3>Opciones adicionales</h3>\n                            <p><strong>Mensaje de globo:</strong> ${o.adicionales.motivo}</p>\n                            <p><strong>Globos:</strong> ${o.adicionales.globos}</p>\n                            <p><strong>Color de globo:</strong> \n                        ${o.adicionales.colorGlobo?`<img src="${o.adicionales.colorGlobo}" alt="Color de globo" \n                                style="width: 50px; height: 50px; border-radius: 50%; margin-left: 10px; cursor: pointer;" \n                                class="imagen-globo" data-url="${o.adicionales.colorGlobo}">`:"No especificado"}\n                    </p>\n                            <p><strong>Mensaje:</strong> ${o.adicionales.mensaje}</p>\n                        </div>\n                    </div>\n                    \n                    <button id="cerrar-detalle" style="margin-top: 20px;" class="btn-cerrar">Cerrar</button>\n                `;const d=document.getElementById("cambiar-estado");d&&d.addEventListener("change",(e=>{const t=e.target.value,o=e.target.getAttribute("data-key");pedidosRef.child(o).update({estado:t}).then((()=>{alert("Estado actualizado correctamente"),cargarPedidos(filtroEstado.value)})).catch((e=>{console.error("Error al actualizar estado: ",e),alert("Error al actualizar el estado")}))}));const r=document.getElementById("cerrar-detalle");r&&r.addEventListener("click",(()=>{pedidoDetalle.style.display="none"}));const s=document.querySelector(".imagen-globo");s&&s.addEventListener("click",(e=>{mostrarImagenGlobo(e.target.getAttribute("data-url"))}));document.querySelectorAll(".producto-nombre").forEach((e=>{e.addEventListener("click",(e=>{mostrarImagenProducto(e.target.getAttribute("data-id"),e.target.textContent)}))}))}else pedidoDetalle.innerHTML="<p>No se encontró el pedido</p>"})).catch((e=>{console.error("Error al obtener detalle del pedido: ",e),pedidoDetalle.innerHTML="<p>Error al cargar el detalle del pedido</p>"}))}btnBuscarEstado.addEventListener("click",aplicarFiltros),btnBuscarCodigo.addEventListener("click",aplicarFiltros),btnBuscarFecha.addEventListener("click",aplicarFiltros),btnBuscarCliente.addEventListener("click",aplicarFiltros),document.getElementById("btn-reiniciar").addEventListener("click",(()=>{limpiarFiltros(),cargarPedidos()})),document.querySelectorAll("#filtro-estado, #filtro-codigo, #filtro-fecha, #filtro-cliente").forEach((e=>{e.addEventListener("keypress",(e=>{"Enter"===e.key&&aplicarFiltros()}))}));const adicionesImagenes={"Adición 1":"https://i.imgur.com/QCt7bA6.png","Adición 2":"https://i.imgur.com/QCt7bA6.png","Adición 3":"https://i.imgur.com/lyiV8pA.png","Adición 4":"https://i.imgur.com/1YG9Upu.png","Adición 5":"https://i.imgur.com/1LILDVR.png","Adición 6":"https://i.imgur.com/omtSZT4.png","Adición 7":"https://i.imgur.com/JjjXD77.png","Adición 8":"https://i.imgur.com/6dypzbK.png","Adición 9":"https://i.imgur.com/2sYjlbX.png","Adición 10":"https://i.imgur.com/Sf8scrq.png","Adición 11":"https://i.imgur.com/qpTHva8.png","Adición 12":"https://i.imgur.com/TSUl4wl.png","Adición 13":"https://i.imgur.com/E2b8Bwc.png","Adición 14":"https://i.imgur.com/PKZbM2Y.png","Adición 15":"https://i.imgur.com/xILkSfu.png","Adición 16":"https://i.imgur.com/CNXzi6J.png","Adición 17":"https://i.imgur.com/eTINNKP.png","Adición 18":"https://i.imgur.com/62JN9jo.png","Adición 19":"https://i.imgur.com/MlylH5W.png","Adición 20":"https://i.imgur.com/Vl5q0fg.png","Adición 21":"https://i.imgur.com/WMkSJkS.png","Adición 22":"https://i.imgur.com/X9o5Kxb.png","Adición 23":"https://i.imgur.com/qORtxYP.jpg","Adición 24":"https://i.imgur.com/t2StrTz.png","Adición 25":"https://i.imgur.com/mekXaIa.png","Adición 26":"https://i.imgur.com/vzsP2Th.png","Adición 27":"https://i.imgur.com/JowfvMi.png","Adición 28":"https://i.imgur.com/YO3pPDm.png","Adición 29":"https://i.imgur.com/0tcCO1N.png","Adición 30":"https://i.imgur.com/lI6m7um.png","Adición 31":"https://i.imgur.com/gNzaPFU.png","Adición 32":"https://i.imgur.com/nb2L7YT.png","Adición 33":"https://i.imgur.com/1Y2sUf5.jpg","Adición 34":"https://i.imgur.com/lBAfAkc.jpg","Adición 35":"https://i.imgur.com/ugOwirx.jpg","Adición 36":"https://i.imgur.com/AKx1onW.jpg","Adición 37":"https://i.imgur.com/qORtxYP.jpg","Adición 38":"https://i.imgur.com/pGN1q79.jpg","Adición 39":"https://i.imgur.com/2j860Nb.png"};function mostrarImagenGlobo(e){modalTitle.textContent="Color de globo",modalImage.src=e,modalImage.alt="Color de globo",modal.style.display="block"}function mostrarImagenProducto(e,t){if(modalTitle.textContent=t,modalImage.src="",modal.style.display="block",modalImage.alt="Cargando imagen...",t.startsWith("Adición")){const e=adicionesImagenes[t];return e?(modalImage.src=e,void(modalImage.alt=t)):(modalTitle.textContent=t+" (No se encontró la imagen)",void(modalImage.alt="Imagen no encontrada"))}const o=["arreglos","box","desayunos","fresas","frutales","carrusel1","diaespecial"];let n=!1;!function e(i){if(i>=o.length)return void(n||(modalTitle.textContent=t+" (No se encontró la imagen)",modalImage.alt="Imagen no encontrada"));const a=o[i];productosRef.child(a).once("value").then((o=>{o.exists()&&o.forEach((e=>{const o=e.val();return o.nombre===t?(n=!0,o.imagen?(modalImage.src=o.imagen,modalImage.alt=t,console.log(`Imagen encontrada para ${t} en categoría ${a}`)):(modalImage.alt="Este producto no tiene imagen",console.log(`Producto encontrado sin imagen: ${t} en ${a}`)),!0):!n&&o.nombre&&t&&o.nombre.toLowerCase()===t.toLowerCase()?(n=!0,o.imagen?(modalImage.src=o.imagen,modalImage.alt=t,console.log(`Imagen encontrada (case insensitive) para ${t} en ${a}`)):(modalImage.alt="Este producto no tiene imagen",console.log(`Producto encontrado sin imagen (case insensitive): ${t} en ${a}`)),!0):void 0})),n||e(i+1)})).catch((t=>{console.error(`Error al buscar en ${a}:`,t),e(i+1)}))}(0),console.log(`Buscando producto: ${t} (ID: ${e})`)}if(closeModal.addEventListener("click",(()=>{modal.style.display="none"})),window.addEventListener("click",(e=>{e.target===modal&&(modal.style.display="none")})),filtroEstado.addEventListener("change",(()=>{cargarPedidos(filtroEstado.value)})),document.addEventListener("DOMContentLoaded",(()=>{cargarPedidos()})),function(){const e=firebase.initializeApp({apiKey:"AIzaSyC5QFujt2nmR40p6lXh3Yft7e7gxsvu7oY",authDomain:"morenitta-57ed3.firebaseapp.com",databaseURL:"https://morenitta-57ed3-default-rtdb.firebaseio.com",projectId:"morenitta-57ed3",storageBucket:"morenitta-57ed3.appspot.com",messagingSenderId:"813042769292",appId:"1:813042769292:web:e9bf4d9ba0eb80919ccaa9"},"notificationApp").database().ref("pedidos"),t=Date.now();function o(){return"Notification"in window?"granted"===Notification.permission?(console.log("Permisos de notificación ya concedidos."),!0):"denied"===Notification.permission?(console.log("Permisos de notificación están bloqueados."),!1):void Notification.requestPermission().then((function(e){return"granted"===e?(console.log("Permisos de notificación concedidos!"),new Notification("Sistema de notificaciones activado",{body:"Las notificaciones de nuevos pedidos están habilitadas.",icon:"https://i.imgur.com/cEeTbd6.png"}),!0):(console.log("Permisos de notificación rechazados."),!1)})):(console.log("Este navegador no soporta notificaciones."),!1)}console.log("Notification system initialized at:",new Date(t).toLocaleString()),window.addEventListener("load",(function(){const n=document.createElement("button");n.textContent="Activar Notificaciones",n.style.position="fixed",n.style.bottom="10px",n.style.right="10px",n.style.zIndex="9999",n.style.padding="8px 12px",n.style.backgroundColor="#4CAF50",n.style.color="white",n.style.border="none",n.style.borderRadius="4px",n.style.cursor="pointer",n.addEventListener("click",(function(){o()&&(this.style.display="none")})),document.body.appendChild(n),o()&&(console.log("Configurando listener de nuevos pedidos..."),e.on("child_added",(function(e){const o=e.val();if(o&&o.timestamp&&("number"==typeof o.timestamp?o.timestamp:Number(o.timestamp))>t&&(console.log("¡NUEVO PEDIDO DETECTADO!",o),"granted"===Notification.permission)){const e=new Notification("¡Nuevo Pedido!",{body:`Cliente: ${o.cliente?.nombre||"N/A"}\nTotal: $${o.total||"0"}`,icon:"https://i.imgur.com/cEeTbd6.png",requireInteraction:!0});try{const e=new Audio("https://assets.mixkit.co/sfx/preview/mixkit-bell-notification-933.mp3");e.volume=.8,e.play()}catch(e){console.error("Error al reproducir sonido:",e)}e.onclick=function(){window.focus(),this.close()}}})),n.style.display="none")}))}(),!firebase.apps.length){const e={apiKey:"AIzaSyC5QFujt2nmR40p6lXh3Yft7e7gxsvu7oY",authDomain:"morenitta-57ed3.firebaseapp.com",databaseURL:"https://morenitta-57ed3-default-rtdb.firebaseio.com",projectId:"morenitta-57ed3",storageBucket:"morenitta-57ed3.appspot.com",messagingSenderId:"813042769292",appId:"1:813042769292:web:e9bf4d9ba0eb80919ccaa9"};firebase.initializeApp(e)}const auth=firebase.auth(),database=firebase.database();auth.onAuthStateChanged((function(e){if(e){database.ref("admis").once("value").then((t=>{const o=t.val();let n=!1;o&&Object.keys(o).forEach((t=>{const i=o[t];i.email===e.email&&!0===i.isAdmin&&(n=!0)})),n?console.log("Usuario autenticado como administrador"):(alert("No eres admin"),window.location.href="perfil.html")})).catch((e=>{console.error("Error al verificar el rol del usuario:",e),alert("Error al verificar permisos de administrador"),window.location.href="perfil.html"}))}else alert("No has iniciado sesión"),window.location.href="perfil.html"}));